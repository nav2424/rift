# Phase 3 Implementation: Delivery Proof by Category + Release Gating + Auto Rules

## Overview

Phase 3 implements category-specific delivery proof mechanisms, deterministic release rules, and auto-triage signals for disputes.

## ✅ Completed Components

### 1. Database Schema

#### Supabase Migrations
- **`supabase/migrations/004_phase3_delivery_proof.sql`**
  - `digital_deliveries` table: Stores uploaded digital files
  - `delivery_views` table: Tracks buyer engagement (view time, downloads)
  - `ticket_transfers` table: Manages ticket transfer workflow
  - RLS policies for all tables
  - Indexes for performance

#### Prisma Schema Updates
- Added to `RiftTransaction`:
  - `eventDateTz` (DateTime?): Event date as timestamptz for queries
  - `holdUntil` (DateTime?): Risk-based hold date
  - `riskScore` (Int, default 0): Risk score 0-100
  - `releaseEligibleAt` (DateTime?): When funds become eligible

**Migration Required**: Run `npx prisma migrate dev` to apply schema changes.

### 2. API Routes

#### Digital Goods
- `POST /api/rifts/[id]/delivery/upload` - Seller uploads file
- `POST /api/rifts/[id]/delivery/viewer` - Buyer opens viewer (creates session)
- `PATCH /api/rifts/[id]/delivery/viewer` - Update engagement time (ping)
- `GET /api/rifts/[id]/delivery/download` - Generate signed download URL
- `POST /api/rifts/[id]/delivery/confirm-receipt` - Buyer confirms receipt

#### Services
- `POST /api/rifts/[id]/services/mark-delivered` - Seller marks delivered
- `POST /api/rifts/[id]/services/confirm-completion` - Buyer confirms completion

#### Tickets
- `POST /api/rifts/[id]/tickets/claim-transfer-sent` - Seller claims transfer sent
- `POST /api/rifts/[id]/tickets/confirm-receipt` - Buyer confirms receipt

#### Release Engine
- `GET /api/rifts/[id]/release/check-eligibility` - Check release eligibility
- `POST /api/rifts/[id]/release` - Release funds (updated to use release engine)

### 3. Core Services

#### `lib/release-engine.ts`
- `computeReleaseEligibility(riftId)`: Deterministic eligibility rules by category
- `releaseFunds(riftId, requestMeta)`: Process fund release with event logging

**Release Rules by Category:**

**Digital Goods:**
- Eligible if buyer confirmed receipt OR
- 48h after upload + (downloaded OR viewed 30+ seconds) + low risk (riskScore <= 30)

**Services:**
- Eligible if buyer confirmed completion OR
- Auto-release after 3 days (low risk) or 7 days (high risk) from seller_marked_delivered

**Tickets:**
- Eligible if buyer confirmed receipt OR
- Event date passed + seller_sent + no dispute + low risk (riskScore <= 50)

#### `lib/rift-messaging.ts`
- `postSystemMessage(riftId, message)`: Post system messages to conversations

### 4. UI Components

#### `components/DeliveryViewer.tsx`
- Full-screen delivery viewer for digital goods
- Tracks engagement time (pings server every 10s)
- Download button with signed URL
- Shows time viewed

#### `components/DeliveryStatus.tsx`
- Shows delivery/transfer status by category
- Digital: File info, upload status
- Tickets: Provider, transfer email, status
- Services: Delivery confirmation status

#### `components/RiftActions.tsx` (Updated)
- Category-specific actions:
  - **Digital**: Upload Delivery (seller), Open Delivery + Confirm Receipt (buyer)
  - **Services**: Mark Delivered (seller), Confirm Completion (buyer)
  - **Tickets**: Claim Transfer Sent (seller), Confirm Receipt (buyer)

#### `app/rifts/[id]/delivery/page.tsx`
- Full-page delivery viewer route

#### `app/rifts/[id]/page.tsx` (Updated)
- Added DeliveryStatus component
- Shows category-specific delivery information

### 5. Event Logging

All actions log events to `rift_events` table:
- `SELLER_UPLOADED_DIGITAL_DELIVERY`
- `BUYER_VIEWED_DELIVERY`
- `BUYER_DOWNLOADED_DELIVERY`
- `SELLER_MARKED_DELIVERED`
- `BUYER_CONFIRMED_RECEIPT`
- `SELLER_CLAIMED_TRANSFER_SENT`
- `BUYER_CONFIRMED_TICKET_RECEIPT`
- `RELEASE_ELIGIBLE`
- `FUNDS_RELEASED`

## Setup Instructions

### 1. Database Migrations

```bash
# Supabase migration
# Apply via Supabase Dashboard SQL Editor or CLI:
supabase db push

# Prisma migration
npx prisma migrate dev --name phase3_delivery_proof
npx prisma generate
```

### 2. Supabase Storage Bucket

Create a storage bucket named `digital-deliveries` in Supabase:
1. Go to Storage in Supabase Dashboard
2. Create new bucket: `digital-deliveries`
3. Set to **Private** (not public)
4. Configure policies:
   - Upload: Service role only (handled by API)
   - Download: Signed URLs only (generated by API)

### 3. Environment Variables

Ensure these are set (should already exist from Phase 1/2):
```
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
```

## Usage Flows

### Digital Goods Flow
1. Seller uploads file → `digital_deliveries` created, status → `DELIVERED_PENDING_RELEASE`
2. Buyer opens viewer → `delivery_views` session created, engagement tracked
3. Buyer downloads → `downloaded=true`, download event logged
4. Buyer confirms receipt → `releaseEligibleAt` set, eligible for release
5. Auto-release after 48h if conditions met (engagement + low risk)

### Services Flow
1. Seller marks delivered → Status → `DELIVERED_PENDING_RELEASE`, event logged
2. Buyer confirms completion → `releaseEligibleAt` set, eligible for release
3. Auto-release after 3-7 days (risk-based) if buyer doesn't confirm

### Tickets Flow
1. Seller claims transfer sent → `ticket_transfers.status='seller_sent'`, event logged
2. Buyer confirms receipt → `status='buyer_confirmed'`, `releaseEligibleAt` set
3. Auto-release after event date passes (if low risk) OR buyer confirms

## Dispute Auto-Triage Signals

The system tracks engagement signals for digital goods:
- `delivery_views.downloaded=true` → Strong signal buyer received
- `delivery_views.seconds_viewed >= 30` → Signal buyer engaged
- These signals are available in `delivery_views` table for Phase 4 dispute triage

## Testing Checklist

- [ ] Digital goods: Upload → View → Download → Confirm → Release
- [ ] Services: Mark delivered → Confirm completion → Release
- [ ] Tickets: Claim sent → Confirm receipt → Release
- [ ] Release eligibility API returns correct results
- [ ] System messages appear in chat
- [ ] Events logged to `rift_events`
- [ ] Delivery status displays correctly
- [ ] Category-specific actions show/hide correctly

## Notes

- Status values use existing `EscrowStatus` enum (FUNDED, DELIVERED_PENDING_RELEASE, etc.)
- RLS policies use service role for server-side operations (validated at API level)
- Release engine integrates with existing `transitionRiftState` for wallet operations
- All file uploads go to Supabase Storage (private bucket)
- Signed URLs expire after 1 hour for security

## Next Steps (Phase 4)

- Implement dispute auto-triage using engagement signals
- Add admin queue for dispute review
- Enhance risk scoring based on transaction history
- Add scheduled job for auto-release processing

