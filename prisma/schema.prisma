generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id        String   @id
  userId    String
  type      String
  amount    Float?
  summary   String
  metadata  String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, createdAt])
}

model Badge {
  id          String      @id
  code        String      @unique
  label       String
  description String
  icon        String?
  createdAt   DateTime    @default(now())
  UserBadge   UserBadge[]
}

model Dispute {
  id                              String             @id
  escrowId                        String
  raisedById                      String
  reason                          String
  type                            DisputeType        @default(ITEM_NOT_RECEIVED)
  status                          DisputeStatus      @default(OPEN)
  resolution                      DisputeResolution?
  evidence                        Json?
  adminNotes                      String?
  resolvedById                    String?
  resolvedAt                      DateTime?
  createdAt                       DateTime           @default(now())
  updatedAt                       DateTime
  RiftTransaction                 RiftTransaction    @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  User_Dispute_raisedByIdToUser   User               @relation("Dispute_raisedByIdToUser", fields: [raisedById], references: [id])
  User_Dispute_resolvedByIdToUser User?              @relation("Dispute_resolvedByIdToUser", fields: [resolvedById], references: [id])
}

model RiftTransaction {
  id                        String             @id
  riftNumber                Int                @unique
  itemTitle                 String
  itemDescription           String
  itemType                  ItemType           @default(PHYSICAL)
  amount                    Float?
  currency                  String             @default("CAD")
  status                    EscrowStatus       @default(DRAFT)
  buyerId                   String
  sellerId                  String
  shippingAddress           String?
  notes                     String?
  paymentReference          String?
  stripePaymentIntentId     String?
  shipmentVerifiedAt        DateTime?
  trackingVerified          Boolean            @default(false)
  deliveryVerifiedAt        DateTime?
  gracePeriodEndsAt         DateTime?
  autoReleaseScheduled      Boolean            @default(false)
  eventDate                 String?
  venue                     String?
  transferMethod            String?
  downloadLink              String?
  licenseKey                String?
  serviceDate               String?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime
  platformFee               Float?
  sellerPayoutAmount        Float?
  subtotal                  Float
  buyerFee                  Float
  sellerFee                 Float
  sellerNet                 Float?
  stripeChargeId            String?
  autoReleaseAt             DateTime?
  proofSubmittedAt          DateTime?
  fundedAt                  DateTime?
  releasedAt                DateTime?
  version                   Int                @default(0)
  allowsPartialRelease      Boolean            @default(false)
  completionCriteria        String?
  fileStorageType           String?
  licenseKeyRevealed        Boolean            @default(false)
  licenseKeyType            String?
  licensePlatform           String?
  milestones                Json?
  quantity                  Int?
  seatDetails               String?
  serviceDeliverables       String?
  serviceScope              String?
  requiresManualReview      Boolean            @default(false)
  eventDateTz               DateTime?
  holdUntil                 DateTime?
  riskScore                 Int                @default(0)
  releaseEligibleAt         DateTime?
  requiresBuyerConfirmation Boolean            @default(false)
  stripeCustomerId          String?
  paidAt                    DateTime?
  Dispute                   Dispute[]
  buyer                     User               @relation("EscrowBuyer", fields: [buyerId], references: [id])
  seller                    User               @relation("EscrowSeller", fields: [sellerId], references: [id])
  MilestoneRelease          MilestoneRelease[]
  Payout                    Payout[]
  Proof                     Proof[]
  ShipmentProof             ShipmentProof[]
  TimelineEvent             TimelineEvent[]
  admin_reviews             admin_reviews[]
  rift_events               rift_events[]
  vault_assets              vault_assets[]
  vault_events              vault_events[]

  @@map("EscrowTransaction")
}

model MilestoneRelease {
  id              String          @id
  riftId          String
  milestoneIndex  Int
  milestoneTitle  String
  milestoneAmount Float
  releasedAmount  Float
  sellerFee       Float
  sellerNet       Float
  releasedBy      String
  releasedAt      DateTime        @default(now())
  status          String          @default("RELEASED")
  payoutId        String?
  notes           String?
  RiftTransaction RiftTransaction @relation(fields: [riftId], references: [id], onDelete: Cascade)

  @@index([releasedAt])
  @@index([releasedBy])
  @@index([riftId])
  @@unique([riftId, milestoneIndex]) // Prevents duplicate milestone releases
}

model Payout {
  id               String           @id
  userId           String
  riftId           String?
  amount           Float
  currency         String           @default("CAD")
  status           PayoutStatus     @default(PENDING)
  scheduledAt      DateTime?
  processedAt      DateTime?
  stripePayoutId   String?
  stripeTransferId String?
  failureReason    String?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  RiftTransaction  RiftTransaction? @relation(fields: [riftId], references: [id])
  User             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([riftId])
  @@index([status, scheduledAt])
  @@index([userId])
}

model Proof {
  id              String          @id
  riftId          String
  proofType       ProofType
  proofPayload    Json
  uploadedFiles   String[]
  status          ProofStatus     @default(PENDING)
  submittedAt     DateTime        @default(now())
  validatedAt     DateTime?
  validatedBy     String?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  RiftTransaction RiftTransaction @relation(fields: [riftId], references: [id], onDelete: Cascade)

  @@index([riftId])
  @@index([status])
}

model ShipmentProof {
  id              String          @id
  escrowId        String
  trackingNumber  String?
  shippingCarrier String?
  filePath        String?
  notes           String?
  verified        Boolean         @default(false)
  deliveryStatus  String?
  deliveryDate    DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  RiftTransaction RiftTransaction @relation(fields: [escrowId], references: [id], onDelete: Cascade)
}

model TimelineEvent {
  id              String          @id
  escrowId        String
  type            String
  message         String
  createdById     String?
  createdAt       DateTime        @default(now())
  User            User?           @relation(fields: [createdById], references: [id])
  RiftTransaction RiftTransaction @relation(fields: [escrowId], references: [id], onDelete: Cascade)
}

model User {
  id                                    String             @id
  name                                  String?
  email                                 String             @unique
  phone                                 String?            @unique
  passwordHash                          String
  role                                  String             @default("USER")
  createdAt                             DateTime           @default(now())
  updatedAt                             DateTime
  totalProcessedAmount                  Float              @default(0)
  availableBalance                      Float              @default(0)
  pendingBalance                        Float              @default(0)
  numCompletedTransactions              Int                @default(0)
  averageRating                         Float?
  responseTimeMs                        Int?
  level                                 String             @default("ROOKIE")
  xp                                    Int                @default(0)
  showInActivityFeed                    Boolean            @default(true)
  showAmountsInFeed                     Boolean            @default(true)
  idVerified                            Boolean            @default(false)
  bankVerified                          Boolean            @default(false)
  emailVerified                         Boolean            @default(false)
  phoneVerified                         Boolean            @default(false)
  stripeConnectAccountId                String?
  stripeIdentityVerified                Boolean            @default(false)
  riftUserId                            String?            @unique
  Activity                              Activity[]
  Dispute_Dispute_raisedByIdToUser      Dispute[]          @relation("Dispute_raisedByIdToUser")
  Dispute_Dispute_resolvedByIdToUser    Dispute[]          @relation("Dispute_resolvedByIdToUser")
  buyerTransactions                     RiftTransaction[]  @relation("EscrowBuyer")
  sellerTransactions                    RiftTransaction[]  @relation("EscrowSeller")
  Payout                                Payout[]
  TimelineEvent                         TimelineEvent[]
  UserBadge                             UserBadge[]
  UserBlock_UserBlock_blockedByIdToUser UserBlock[]        @relation("UserBlock_blockedByIdToUser")
  UserBlock_UserBlock_userIdToUser      UserBlock[]        @relation("UserBlock_userIdToUser")
  UserMilestone                         UserMilestone[]
  UserRiskProfile                       UserRiskProfile?
  VerificationCode                      VerificationCode[]
  WalletAccount                         WalletAccount?
  admin_reviews                         admin_reviews[]
  vault_assets                          vault_assets[]

  @@index([riftUserId])
}

model UserBadge {
  id        String   @id
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  Badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model UserBlock {
  id                               String   @id
  userId                           String
  blockedById                      String
  reason                           String
  metadata                         Json?
  createdAt                        DateTime @default(now())
  User_UserBlock_blockedByIdToUser User     @relation("UserBlock_blockedByIdToUser", fields: [blockedById], references: [id], onDelete: Cascade)
  User_UserBlock_userIdToUser      User     @relation("UserBlock_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedById])
  @@index([userId])
}

model UserMilestone {
  id          String   @id
  userId      String
  type        String
  title       String
  description String
  achievedAt  DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model UserRiskProfile {
  id                    String    @id
  userId                String    @unique
  tier                  RiskTier  @default(TIER0_NEW)
  completedRifts        Int       @default(0)
  accountAgeDays        Int       @default(0)
  chargebacksLast60Days Int       @default(0)
  disputesLast60Days    Int       @default(0)
  totalVolume           Float     @default(0)
  lastChargebackAt      DateTime?
  lastDisputeAt         DateTime?
  tier3Approved         Boolean   @default(false)
  tier3ApprovedAt       DateTime?
  tier3ApprovedBy       String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  User                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@index([userId])
}

model VerificationCode {
  id              String           @id
  userId          String? // Optional - used for existing users. Either userId or sessionId must be set (enforced by DB constraint)
  type            String
  code            String
  contactInfo     String
  expiresAt       DateTime
  attempts        Int              @default(0)
  createdAt       DateTime         @default(now())
  sessionId       String? // Optional - used for signup sessions. Either userId or sessionId must be set (enforced by DB constraint)
  signup_sessions signup_sessions? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  User            User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Database constraint: CHECK (("userId" IS NOT NULL) OR ("sessionId" IS NOT NULL))
  // Ensures at least one of userId or sessionId is present

  @@index([expiresAt])
  @@index([sessionId, type])
  @@index([userId, type])
}

model WalletAccount {
  id                String              @id
  userId            String              @unique
  currency          String              @default("CAD")
  availableBalance  Float               @default(0)
  pendingBalance    Float               @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  WalletLedgerEntry WalletLedgerEntry[]

  @@index([userId])
}

model WalletLedgerEntry {
  id              String           @id
  walletAccountId String
  type            WalletLedgerType
  amount          Float
  currency        String           @default("CAD")
  relatedRiftId   String?
  metadata        Json?
  createdAt       DateTime         @default(now())
  WalletAccount   WalletAccount    @relation(fields: [walletAccountId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([relatedRiftId])
  @@index([walletAccountId, createdAt])
}

model admin_audit_logs {
  id            String           @id
  adminUserId   String
  action        AdminAuditAction
  objectType    String?
  objectId      String?
  beforeState   Json?
  afterState    Json?
  reasonCode    String?
  notes         String?
  ipHash        String?
  sessionId     String?
  userAgentHash String?
  timestampUtc  DateTime         @default(now())
  admin_users   admin_users      @relation(fields: [adminUserId], references: [id])

  @@index([action])
  @@index([adminUserId])
  @@index([objectType, objectId])
  @@index([timestampUtc])
}

model admin_permissions {
  id                     String                   @id
  name                   AdminPermission          @unique
  description            String
  createdAt              DateTime                 @default(now())
  admin_role_permissions admin_role_permissions[]
}

model admin_reviews {
  id              String            @id
  riftId          String
  reviewerId      String?
  status          AdminReviewStatus @default(OPEN)
  reasonsJson     Json?
  notes           String?
  createdAt       DateTime          @default(now())
  resolvedAt      DateTime?
  User            User?             @relation(fields: [reviewerId], references: [id])
  RiftTransaction RiftTransaction   @relation(fields: [riftId], references: [id], onDelete: Cascade)

  @@index([reviewerId])
  @@index([riftId])
  @@index([status])
}

model admin_role_permissions {
  id                String            @id
  roleId            String
  permissionId      String
  createdAt         DateTime          @default(now())
  admin_permissions admin_permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  admin_roles       admin_roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
  @@index([roleId])
}

model admin_roles {
  id                     String                   @id
  name                   AdminRole                @unique
  description            String
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  admin_role_permissions admin_role_permissions[]
  admin_user_roles       admin_user_roles[]
}

model admin_sessions {
  id                String      @id
  adminUserId       String
  sessionToken      String      @unique
  ipHash            String?
  userAgentHash     String?
  deviceFingerprint String?
  isActive          Boolean     @default(true)
  expiresAt         DateTime
  lastActivityAt    DateTime    @default(now())
  createdAt         DateTime    @default(now())
  admin_users       admin_users @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([expiresAt])
  @@index([isActive])
}

model admin_user_roles {
  id          String      @id
  userId      String
  roleId      String
  grantedBy   String?
  grantedAt   DateTime    @default(now())
  expiresAt   DateTime?
  admin_roles admin_roles @relation(fields: [roleId], references: [id], onDelete: Cascade)
  admin_users admin_users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
  @@index([userId])
}

model admin_users {
  id                   String             @id
  email                String             @unique
  name                 String
  passwordHash         String
  mfaSecret            String?
  mfaEnabled           Boolean            @default(false)
  isBreakGlass         Boolean            @default(false)
  isActive             Boolean            @default(true)
  lastLoginAt          DateTime?
  lastLoginIp          String?
  failedLoginAttempts  Int                @default(0)
  lockedUntil          DateTime?
  ssoProvider          String?
  ssoId                String?
  deviceTrustTokens    String[]
  ipAllowlist          String[]
  sessionDurationHours Int                @default(8)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  admin_audit_logs     admin_audit_logs[]
  admin_sessions       admin_sessions[]
  admin_user_roles     admin_user_roles[]

  @@index([email])
  @@index([isActive])
}

model rift_events {
  id                String             @id
  riftId            String
  actorType         RiftEventActorType
  actorId           String?
  eventType         String
  payload           Json
  ipHash            String?
  deviceFingerprint String?
  userAgent         String?
  createdAt         DateTime           @default(now())
  RiftTransaction   RiftTransaction    @relation(fields: [riftId], references: [id], onDelete: Cascade)

  @@index([actorType, actorId])
  @@index([eventType])
  @@index([riftId, createdAt])
}

model signup_sessions {
  id               String             @id
  email            String             @unique
  phone            String?
  name             String?
  firstName        String?
  lastName         String?
  birthday         DateTime?
  passwordHash     String?
  emailVerified    Boolean            @default(false)
  phoneVerified    Boolean            @default(false)
  passwordSet      Boolean            @default(false)
  expiresAt        DateTime
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  VerificationCode VerificationCode[]

  @@index([email])
  @@index([expiresAt])
}

model stripe_webhook_events {
  id          String    @id
  type        String
  livemode    Boolean
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([livemode])
  @@index([processedAt])
  @@index([type])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model vault_assets {
  id                 String          @id
  riftId             String
  uploaderId         String
  assetType          VaultAssetType
  storagePath        String?
  fileName           String?
  sha256             String
  mimeDetected       String?
  scanStatus         VaultScanStatus @default(PENDING)
  qualityScore       Int?
  metadataJson       Json?
  supersedesAssetId  String?
  encryptedData      String?
  url                String?
  trackingNumber     String?
  textContent        String?
  createdAt          DateTime        @default(now())
  canonicalSha256    String?
  perceptualHash     String?
  averageHash        String?
  RiftTransaction    RiftTransaction @relation(fields: [riftId], references: [id], onDelete: Cascade)
  vault_assets       vault_assets?   @relation("vault_assetsTovault_assets", fields: [supersedesAssetId], references: [id])
  other_vault_assets vault_assets[]  @relation("vault_assetsTovault_assets")
  User               User            @relation(fields: [uploaderId], references: [id])
  vault_events       vault_events[]

  @@index([averageHash])
  @@index([canonicalSha256])
  @@index([perceptualHash])
  @@index([riftId])
  @@index([scanStatus])
  @@index([sha256])
  @@index([uploaderId])
}

model vault_events {
  id                String          @id
  riftId            String
  assetId           String?
  actorId           String?
  actorRole         VaultActorRole
  eventType         VaultEventType
  timestampUtc      DateTime        @default(now())
  ipHash            String?
  userAgentHash     String?
  sessionId         String?
  deviceFingerprint String?
  assetHash         String?
  prevLogHash       String?
  logHash           String
  metadata          Json?
  vault_assets      vault_assets?   @relation(fields: [assetId], references: [id])
  RiftTransaction   RiftTransaction @relation(fields: [riftId], references: [id], onDelete: Cascade)

  @@index([actorId, actorRole])
  @@index([assetId])
  @@index([eventType])
  @@index([logHash])
  @@index([riftId, timestampUtc])
}

enum AdminAuditAction {
  USER_VIEWED
  USER_FROZEN
  USER_UNFROZEN
  USER_BANNED
  USER_UNBANNED
  USER_RESTRICTED
  USER_VERIFIED
  RIFT_VIEWED
  RIFT_FORCE_UNDER_REVIEW
  RIFT_APPROVED
  RIFT_REJECTED
  RIFT_ESCALATED
  RIFT_CANCELED
  VAULT_VIEWED
  VAULT_DOWNLOADED_RAW
  VAULT_PROOF_APPROVED
  VAULT_PROOF_REJECTED
  DISPUTE_VIEWED
  DISPUTE_RESOLVED_SELLER
  DISPUTE_RESOLVED_BUYER
  DISPUTE_REQUESTED_INFO
  PAYOUT_VIEWED
  PAYOUT_PAUSED
  PAYOUT_RESUMED
  PAYOUT_SCHEDULED
  PAYOUT_HELD
  RISK_SCORE_UPDATED
  RISK_AUTO_HOLD_SET
  FEATURE_FLAG_UPDATED
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  MFA_ENABLED
  MFA_DISABLED
  SESSION_EXPIRED
  BREAK_GLASS_ACCESSED
  ROLE_GRANTED
  ROLE_REVOKED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  USER_DELETED
}

enum AdminPermission {
  VAULT_READ
  VAULT_DOWNLOAD_RAW
  VAULT_REJECT_PROOF
  VAULT_APPROVE_PROOF
  VAULT_VIEW_METADATA
  RIFT_READ
  RIFT_FORCE_UNDER_REVIEW
  RIFT_APPROVE
  RIFT_REJECT
  RIFT_ESCALATE
  RIFT_CANCEL
  USER_READ
  USER_RESTRICT
  USER_FREEZE
  USER_BAN
  USER_VERIFY
  PAYOUT_READ
  PAYOUT_PAUSE
  PAYOUT_SCHEDULE
  PAYOUT_HOLD
  DISPUTE_READ
  DISPUTE_RESOLVE
  DISPUTE_REQUEST_INFO
  RISK_READ
  RISK_UPDATE_SCORE
  RISK_AUTO_HOLD
  FEATURE_FLAG_READ
  FEATURE_FLAG_UPDATE
  AUDIT_READ
  USER_DELETE
}

enum AdminReviewStatus {
  OPEN
  APPROVED
  REJECTED
  ESCALATED
}

enum AdminRole {
  SUPER_ADMIN
  RISK_ADMIN
  SUPPORT_ADMIN
  OPS_ADMIN
  DEV_ADMIN
}

enum DisputeResolution {
  FULL_RELEASE
  PARTIAL_REFUND
  FULL_REFUND
}

enum DisputeStatus {
  OPEN
  RESOLVED
  UNDER_REVIEW
}

enum DisputeType {
  ITEM_NOT_RECEIVED
  ITEM_NOT_AS_DESCRIBED
  ITEM_DAMAGED
  WRONG_ITEM
  WRONG_ADDRESS
  OTHER
}

enum EscrowStatus {
  DRAFT
  FUNDED
  PROOF_SUBMITTED
  UNDER_REVIEW
  RELEASED
  DISPUTED
  RESOLVED
  PAYOUT_SCHEDULED
  PAID_OUT
  CANCELED
  AWAITING_PAYMENT
  AWAITING_SHIPMENT
  IN_TRANSIT
  DELIVERED_PENDING_RELEASE
  REFUNDED
  CANCELLED
}

enum ItemType {
  PHYSICAL
  DIGITAL_GOODS
  OWNERSHIP_TRANSFER
  SERVICES
}

enum PayoutStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
}

enum ProofStatus {
  PENDING
  VALID
  REJECTED
}

enum ProofType {
  PHYSICAL
  SERVICE
  DIGITAL
}

enum RiftEventActorType {
  BUYER
  SELLER
  SYSTEM
  ADMIN
}

enum RiskTier {
  TIER0_NEW
  TIER1_NORMAL
  TIER2_TRUSTED
  TIER3_PRO
}

enum VaultActorRole {
  BUYER
  SELLER
  ADMIN
  SYSTEM
}

enum VaultAssetType {
  FILE
  LICENSE_KEY
  TRACKING
  TICKET_PROOF
  URL
  TEXT_INSTRUCTIONS
}

enum VaultEventType {
  BUYER_OPENED_ASSET
  BUYER_DOWNLOADED_FILE
  BUYER_REVEALED_LICENSE_KEY
  BUYER_VIEWED_QR
  BUYER_VIEWED_TRACKING
  BUYER_CLICKED_EXTERNAL_LINK
  BUYER_TIME_IN_VIEW
  BUYER_SCROLL_DEPTH
  SELLER_UPLOADED_ASSET
  SELLER_SUBMITTED_PROOF
  ADMIN_VIEWED_ASSET
  ADMIN_DOWNLOADED_RAW
  ADMIN_APPROVED_PROOF
  ADMIN_REJECTED_PROOF
  SYSTEM_SCAN_COMPLETED
  SYSTEM_QUALITY_CHECK_COMPLETED
}

enum VaultScanStatus {
  PENDING
  PASS
  FAIL
}

enum WalletLedgerType {
  CREDIT_RELEASE
  DEBIT_WITHDRAWAL
  DEBIT_CHARGEBACK
  DEBIT_REFUND
  ADJUSTMENT
}
