# Rift Vault Setup Guide

The Rift Vault is a secure file storage system that handles:
- Digital file uploads (PDFs, ZIPs, documents, media)
- License key encryption and storage
- Proof uploads for delivery verification
- Secure file access with signed URLs

## Features

✅ **Secure Storage**: Files stored in Supabase Storage with access control
✅ **SHA-256 Hashing**: Automatic file hash generation for duplicate detection
✅ **Virus Scanning**: Structure in place for virus scanning (integration pending)
✅ **Encryption**: License keys and sensitive data encrypted at rest
✅ **View-Only Mode**: Files can be restricted to view-only (no downloads)
✅ **Access Tracking**: Tracks file access and downloads

## Setup Instructions

### 1. Create Supabase Storage Bucket

1. Go to your Supabase Dashboard
2. Navigate to **Storage**
3. Create a new bucket named `rift-vault`
4. Set bucket to **Private** (not public)
5. Configure policies:
   - **Upload**: Service role only (handled by API)
   - **Download**: Signed URLs only (generated by API)

### 2. Database Migration

Run the migration to create the `vault_files` table:

```bash
npx prisma migrate dev --name add_vault_files
npx prisma generate
```

Or apply the SQL migration manually from `prisma/migrations/20251227230616_add_item_specific_fields/migration.sql`

### 3. Environment Variables

Ensure these are set (should already exist):

```env
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
VAULT_ENCRYPTION_KEY=... # Optional: For license key encryption (generate a secure key)
```

### 4. Update Create Rift Flow

The create rift form now supports file uploads. Files are uploaded to the vault during rift creation.

## API Endpoints

### Upload File to Vault

```
POST /api/vault/upload
Content-Type: multipart/form-data

Form data:
- file: File (required)
- riftId: string (optional, for temp uploads)
- itemType: string (optional, for validation)
- viewOnly: boolean (default: true)
```

Response:
```json
{
  "success": true,
  "metadata": {
    "storagePath": "rifts/{riftId}/{filename}",
    "fileHash": "sha256-hash",
    "fileName": "original-name.pdf",
    "sizeBytes": 12345,
    "mimeType": "application/pdf"
  }
}
```

### Get Secure File URL

```
GET /api/vault/[path]?download=true&expiresIn=3600

Query params:
- download: boolean (default: false)
- expiresIn: number (seconds, default: 3600)
```

Response:
```json
{
  "url": "https://signed-url...",
  "expiresIn": 3600
}
```

## Usage Examples

### Upload File During Rift Creation

```typescript
const formData = new FormData()
formData.append('file', file)
formData.append('riftId', riftId)
formData.append('itemType', 'DIGITAL')
formData.append('viewOnly', 'true')

const response = await fetch('/api/vault/upload', {
  method: 'POST',
  body: formData,
})

const { metadata } = await response.json()
// Use metadata.storagePath to update rift
```

### Access File Securely

```typescript
const path = encodeURIComponent('rifts/rift-id/filename.pdf')
const response = await fetch(`/api/vault/${path}?download=false&expiresIn=3600`)
const { url } = await response.json()

// Use signed URL to display/download file
window.open(url)
```

## Security Features

1. **Access Control**: Only buyers, sellers, and admins can access files
2. **Signed URLs**: Time-limited signed URLs for secure access
3. **File Validation**: File type and size validation
4. **Hash Verification**: SHA-256 hashes for integrity checking
5. **Encryption**: Sensitive data (license keys) encrypted at rest

## Future Enhancements

- [ ] Virus scanning integration (ClamAV or cloud service)
- [ ] File preview/viewer for common formats
- [ ] Download tracking and analytics
- [ ] Automatic file cleanup for abandoned rifts
- [ ] CDN integration for faster delivery

## File Size Limits

- **Maximum file size**: 100MB
- **Recommended**: Keep files under 50MB for better performance

## Supported File Types

### Digital Files
- PDFs: `.pdf`
- Archives: `.zip`
- Documents: `.doc`, `.docx`, `.xls`, `.xlsx`, `.ppt`, `.pptx`
- Images: `.jpg`, `.jpeg`, `.png`, `.gif`
- Video: `.mp4`, `.mov`
- Audio: `.mp3`, `.mpeg`

## License Key Storage

License keys are:
1. Encrypted using AES-256-GCM (when encryption key is set)
2. Stored in `vault_files.encryptedData` field
3. Only revealed to buyer after confirmation
4. Tracked with `licenseKeyRevealed` flag

## Troubleshooting

### Upload Fails
- Check Supabase Storage bucket exists and is named `rift-vault`
- Verify `SUPABASE_SERVICE_ROLE_KEY` is set correctly
- Check file size is under 100MB

### Access Denied
- Verify user is buyer or seller of the rift
- Check file path matches rift's `fileUploadPath`
- Ensure signed URL hasn't expired

### File Not Found
- Verify file was uploaded successfully
- Check `storagePath` in database matches Supabase Storage
- Ensure file wasn't deleted from storage

